@{
    ViewData["Title"] = "Dashboard 1";
}


<section class="container-dashboard">
    <h2>Dashboard 1</h2>
    <section class="container-dados">
        <div class="container-dados__subitens">
            <label>Valor do Erro</label>
            <div class="container-dados__subitens-value">teste</div>
        </div>
        <div class="container-dados__subitens">
            <label>Constante de Tempo</label>
            <div class ="container-dados__subitens-value">teste</div>
        </div>
        <div class="container-dados__subitens">
            <label>Constante de ganho</label>
            <div class="container-dados__subitens-value">teste</div>
        </div>
        <div class="container-dados__subitens">
            <label>Tempo de acomodação</label>
            <div class="container-dados__subitens-value">teste</div>
        </div>
    </section>
    <div class="container-grafico">
        <div class="container-grafico__grafico">
            <canvas id="chartDashboard1"></canvas>
        </div>
        <div class="container-grafico__legenda">
            <table>
                <caption>Legenda</caption>
                <tr>
                    <th>Sigla</th>
                    <th>Descrição</th>
                </tr>
                <tr>
                    <td>LM</td>
                    <td>Valor de luminosidade em %</td>
                </tr>
                <tr>
                    <td>TP</td>
                    <td>Valor de temperatura em °C</td>
                </tr>
                <tr>
                    <td>HD</td>
                    <td>Valor de Humidade em %</td>
                </tr>
            </table>
        </div>

    </div>
    <div class="legenda_dashboard">
        <div>
            <label>Luminosidade</label>
            <div id="luminosity-value"></div>
        </div>
        <div>
            <label>Temperatura</label>
            <div id="temperature-value"></div>
        </div>
        <div>
            <label>Humidade</label>
            <div id="humidity-value"></div>
        </div>
    </div>
</section>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", async function () {
        let chart; // Variável global para o gráfico

        async function fetchDataDashboard1(dataObject) {
            const response = await fetch(`/Dashboard/GetData?dataObject=${dataObject}`);
            const data = await response.json();
            return data.contextResponses[0].contextElement.attributes[0].values;
        }

        function processAPIData(apiData) {
            const labels = [];
            const values = [];

            apiData.forEach(item => {
                labels.push(new Date(item.recvTime).toLocaleTimeString());
                values.push(item.attrValue);
            });

            return { labels, values };
        }

        async function updateChart() {
            const apiDataLuminosity = await fetchDataDashboard1("luminosity");
            const { labels: labels1, values: valuesLuminosity } = processAPIData(apiDataLuminosity);
            
            const apiDataTemperature = await fetchDataDashboard1("temperature");
            const { values: valuesTemperature } = processAPIData(apiDataTemperature);
            
            const apiDataHumidity = await fetchDataDashboard1("humidity");
            const { values: valuesHumidity } = processAPIData(apiDataHumidity);

            document.getElementById('luminosity-value').textContent = valuesLuminosity[valuesLuminosity.length - 1] || 'N/A';
            document.getElementById('temperature-value').textContent = valuesTemperature[valuesTemperature.length - 1] || 'N/A';
            document.getElementById('humidity-value').textContent = valuesHumidity[valuesHumidity.length - 1] || 'N/A';

           if (!chart) {
                // Criar o gráfico pela primeira vez
                const ctx = document.getElementById('chartDashboard1').getContext('2d');
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels1,
                        datasets: [
                            {
                                label: 'Luminosidade - Dashboard 1',
                                data: valuesLuminosity,
                                fill: false,
                                borderColor: 'rgba(75, 192, 192, 1)',
                                tension: 0.1
                            },
                            {
                                label: 'Temperatura - Dashboard 1',
                                data: valuesTemperature,
                                fill: false,
                                borderColor: 'rgba(255, 99, 132, 1)',
                                tension: 0.1
                            },
                            {
                                label: 'Umidade - Dashboard 1',
                                data: valuesHumidity,
                                fill: false,
                                borderColor: 'rgba(54, 162, 235, 1)',
                                tension: 0.1
                            }
                        ]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Valor'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Horário'
                                }
                            }
                        }
                    }
                });
            } else {
                // Atualizar os dados do gráfico existente
                chart.data.labels = labels1;
                chart.data.datasets[0].data = valuesLuminosity;
                chart.data.datasets[1].data = valuesTemperature;
                chart.data.datasets[2].data = valuesHumidity;
                chart.update(); // Atualizar o gráfico com novos dados
            }
        }

        // Atualizar o gráfico ao carregar a página
        await updateChart();

        // Atualizar o gráfico automaticamente a cada 1 minuto (60000 milissegundos)
        setInterval(updateChart, 1000);
    });
</script>
